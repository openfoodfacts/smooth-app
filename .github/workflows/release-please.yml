name: Run release-please
on:
   push:
     branches:
       - develop
       - major-release-update

jobs:

  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/release-please-action@v3
        with:
           token: ${{ secrets.GITHUB_TOKEN }}
           release-type: simple
           changelog-types: '[{"type":"feat","section":"Features","hidden":false},{"type":"fix","section":"Bug Fixes","hidden":false},{"type":"docs","section":"Documentation","hidden":false},{"type":"ci","section":"Automation","hidden":false},{"type":"refactor","section":"Refactoring","hidden":false},{"type":"chore","section":"Miscellaneous","hidden":false}]'

  create-release:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    outputs:
      VERSION_NAME: ${{ steps.set_output.outputs.VERSION_NAME }}
      OLD_VERSION_CODE: ${{ steps.set_output.outputs.OLD_VERSION_CODE }}
    steps:
      - uses: actions/checkout@v2

      - name: Set VERSION_NAME env
        run: echo "VERSION_NAME=${{ needs.release-please.outputs.major }}.${{ needs.release-please.outputs.minor }}.${{ needs.release-please.outputs.patch }}" >> $GITHUB_ENV
        #run: echo "VERSION_NAME=1.9.0" >> $GITHUB_ENV

      - name: Decrypt Android API JSON file
        run: cd ./packages/smooth_app/android/fastlane/envfiles && chmod +x ./decrypt_secrets.sh && ./decrypt_secrets.sh
        env:
          API_JSON_FILE_DECRYPTKEY: ${{ secrets.API_JSON_FILE_DECRYPTKEY }}
          DECRYPT_GPG_KEYSTORE: ${{ secrets.DECRYPT_GPG_KEYSTORE }}
          STORE_JKS_DECRYPTKEY: ${{ secrets.NEW_CYPHER }}

      # We are using the android version code for iOS as well to have the version codes in sync 
      # in order for Sentry and other tools to work properly
      # Outputs env: OLD_VERSION_CODE
      - name: Get latest OLD_VERSION_CODE
        uses: maierj/fastlane-action@v2.2.1
        with:
          lane: getOldVersionCode
          subdirectory: packages/smooth_app/android

      - name: Version
        run: echo ${{ env.RELEASE_VERSION }}


      - name: Tag commit
        uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.RELEASE_VERSION }}
          message: "Release: ${{ env.RELEASE_VERSION }}"

      - name: Set output
        id: set_output
        run: echo "::set-output name=VERSION_NAME::${{ env.VERSION_NAME }}" && echo "::set-output name=OLD_VERSION_CODE::${{ env.OLD_VERSION_CODE }}"

  android-release:
    uses: openfoodfacts/smooth-app/.github/workflows/android-release-to-org-openfoodfacts-scanner.yml@develop
    needs: [release-please, create-release]
    if: ${{ needs.release-please.outputs.release_created }}
    with:
      VERSION_NAME: ${{ needs.create-release.outputs.VERSION_NAME}}
      OLD_VERSION_CODE: ${{ needs.create-release.outputs.OLD_VERSION_CODE}}
      FLUTTER-CACHE-KEY: '3.0.1'
    secrets:
      API_JSON_FILE_DECRYPTKEY: ${{secrets.API_JSON_FILE_DECRYPTKEY }}
      DECRYPT_GPG_KEYSTORE: ${{secrets.DECRYPT_GPG_KEYSTORE }}
      STORE_JKS_DECRYPTKEY: ${{secrets.STORE_JKS_DECRYPTKEY }}
      SIGN_STORE_PASSWORD: ${{secrets.SIGN_STORE_PASSWORD }}
      SIGN_KEY_ALIAS: ${{secrets.SIGN_KEY_ALIAS }}
      SIGN_KEY_PASSWORD: ${{secrets.SIGN_KEY_PASSWORD }}

  iOS-release:
    uses: openfoodfacts/smooth-app/.github/workflows/ios-release-to-org-openfoodfacts-scanner.yml@develop
    needs: [release-please, create-release]
    if: ${{ needs.release-please.outputs.release_created }}
    with:
      VERSION_NAME: ${{ needs.create-release.outputs.VERSION_NAME}}
      OLD_VERSION_CODE: ${{ needs.create-release.outputs.OLD_VERSION_CODE}}
      FLUTTER-CACHE-KEY: '3.0.1'
    secrets:
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN }}
      SENTRY_AUTH_TOKEN: ${{secrets.SENTRY_AUTH_TOKEN }}
      FASTLANE_USER: ${{secrets.FASTLANE_USER }}
      FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
      MATCH_GIT_BASIC_AUTHORIZATION: ${{secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      MATCH_GIT_URL: ${{secrets.MATCH_GIT_URL }}
      MATCH_KEYCHAIN_PASSWORD: ${{secrets.MATCH_KEYCHAIN_PASSWORD }}
      MATCH_PASSWORD: ${{secrets.MATCH_PASSWORD }}
      PILOT_APPLE_ID: ${{secrets.PILOT_APPLE_ID }}
      SPACESHIP_CONNECT_API_ISSUER_ID: ${{secrets.SPACESHIP_CONNECT_API_ISSUER_ID }}
      SPACESHIP_CONNECT_API_KEY_ID: ${{secrets.SPACESHIP_CONNECT_API_KEY_ID }}
